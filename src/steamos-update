#!/bin/zsh
UPD_APP_MANIFEST=$(curl -s http://dl.thevakhovske.pw/manifest/updateapps.txt)
VERSION_LIST_CURR=$(cat /etc/os-release | grep VARIANT_ID | cut -d '"' -f 2)
CMD_DB_UPDATE=$(sudo pacman -Sy | grep -o silent)

# Update pacman DB before starting any update.
${CMD_DB_UPDATE}
sleep 1
# Define update variables only after DB update, to make sure queries are going to be made properly.
CMD_HOLOISO_CHECK_FOR_UPDATES=$(pacman -Qu | grep -e holoiso-main -e holoiso-updateclient -e nvidia -e mesa -e vulkan -e linux-holoiso -e linux-neptune)
CMD_HOLOISO_CHECK_FOR_NVGPU_UPDATES=$(pacman -Qu | grep -e nvidia)
CMD_HOLOISO_CHECK_FOR_KERNEL_UPDATES=$(pacman -Qu | grep -e linux-holoiso -e linux-neptune)
CMD_HOLOISO_CHECK_FOR_MESA_UPDATES_AMD=$(pacman -Qu | grep -e vulkan-radeon -e lib32-vulkan-radeon)
CMD_HOLOISO_CHECK_FOR_MESA_UPDATES_INTEL=$(pacman -Qu | grep -e vulkan-intel -e lib32-vulkan-intel)
CMD_HOLOISO_DEPRECATE_NEPTUNE=$(pacman -Q | grep -e linux-neptune-dri)
IS_NVIDIA=$(echo $(lspci | grep VGA | cut -d ':' -f 3) | grep NVIDIA)
CMD_CHECK_BETA_BRANCH=$(cat /etc/holoiso-branch)

check_download(){
	if [ $1 != 0 ]; then
		echo "\nError: Something went wrong when $2.\nPlease make sure you have a stable internet connection!\n"
        sudo rm /tmp/steamos-updatepersist-sentinel
		exit 1
	fi
}

# Check for available OS updates. Make sure to only check for snapshot updates
updatecheck() {
    if [ -n "${CMD_HOLOISO_CHECK_FOR_UPDATES}" ]; then
        echo "Update(s) available:"
        echo "${CMD_HOLOISO_CHECK_FOR_UPDATES}"
        touch /tmp/steamos-updatepersist-sentinel
        exit 0
    else
        echo "System up to date."
        exit 7
    fi
}

# Check for kernel updates. Little workaround to make it work on HoloISO
checkkernelupd() {
    # Force get rid of linux-neptune-dri
    if [ -n "${CMD_HOLOISO_DEPRECATE_NEPTUNE}" ]; then
        sudo pacman -Rcns --noconfirm linux linux-headers linux-neptune-dri linux-neptune-dri-headers
	echo "deprecated forever."
	sleep 1
        sudo pacman -S --noconfirm --needed --disable-download-timeout linux-holoiso linux-holoiso-headers linux-neptune linux-neptune-headers
        check_download $? "installing neptune-dri replacement"
        sudo mkinitcpio -P
        sudo grub-mkconfig -o /boot/grub/grub.cfg
    fi
    # Check for kernel updates
    if [ -n "${CMD_HOLOISO_CHECK_FOR_KERNEL_UPDATES}" ]; then
        echo "Kernel update available, updating..."
        sudo pacman -S --noconfirm --needed --disable-download-timeout linux-holoiso linux-holoiso-headers linux-neptune linux-neptune-headers
        check_download $? "installing kernel updates"
        sudo mkinitcpio -P
    else
        echo "Kernel update not required, skipping."
    fi
}

# Check for manifest related stuff
checkaddmanifest() {
    sudo holoiso-manifest-updater
}

# Check for MESA and vulkan updates.
checkmesaupd() {
    # Check AMD updates first
    if [ -n "${CMD_HOLOISO_CHECK_FOR_MESA_UPDATES_AMD}" ]; then
        echo "AMD MESA and Vulkan update available, updating..."
        sudo pacman -S --noconfirm --needed --disable-download-timeout holoiso/mesa holoiso/lib32-mesa holoiso/vulkan-radeon holoiso/lib32-vulkan-radeon
        check_download $? "installing mesa updates"
    else
        echo "AMD MESA update not required or not detected, trying to update Intel MESA"
    fi
    # Check Intel updates afterwards if not required.
    if [ -n "${CMD_HOLOISO_CHECK_FOR_MESA_UPDATES_INTEL}" ]; then
        echo "Intel MESA and Vulkan update available, updating..."
        sudo pacman -S --noconfirm --needed --disable-download-timeout holoiso/mesa holoiso/lib32-mesa holoiso/vulkan-intel holoiso/lib32-vulkan-intel
        check_download $? "installing mesa updates"
    else
        echo "Intel MESA update not required or not detected, MESA update not required, skipping entirely"
    fi
}

# We do not want to overwrite GPU drivers by old Syyu command, update GPU drivers as if it would be a regular package installation
checkgpuupd() {
if [ -n "${IS_NVIDIA}" ]; then
    if [ -n "${CMD_HOLOISO_CHECK_FOR_NVGPU_UPDATES}" ]; then
        echo "NVIDIA GPU Driver update available, updating..."
        sudo pacman -S --noconfirm --needed --disable-download-timeout nvidia-dkms opencl-nvidia nvidia-utils lib32-nvidia-utils
        check_download $? "installing nvidia updates"
        sudo depmod -a $(ls /lib/modules)
        sudo mkinitcpio -P
        sudo grub-mkconfig -o /boot/grub/grub.cfg
    else
        echo "NVIDIA GPU Driver update not required, skipping."
    fi
else
    echo "No NVIDIA GPU, skipping update."
fi
}

# Check for sentinel. Sentinel detected = Update time!
export STEAMOS_UPDATE_SENTINEL="/tmp/steamos-updatepersist-sentinel"
if [[ -e "$STEAMOS_UPDATE_SENTINEL" ]]; then
  rm -f "$STEAMOS_UPDATE_SENTINEL"
    sleep .1
    percentage=10%
    echo $percentage
    sudo pacman -Sy --noconfirm --needed --overwrite="*" --disable-download-timeout holoiso-main;
    check_download $? "installing holoiso snapshot"
    percentage=20%
    echo $percentage
    checkkernelupd
    percentage=30%
    echo $percentage
    checkgpuupd
    percentage=40%
    echo $percentage
    checkmesaupd
    percentage=50%
    echo $percentage
    checkaddmanifest
    percentage=60%
    echo $percentage
    echo "HoloISO Update complete, checking OS updates..."
    sudo pacman -Syyu --noconfirm --needed --disable-download-timeout --ignore=grub --ignore=linux
    check_download $? "installing OS updates"
    percentage=70%
    echo $percentage
    percentage=75%
    echo $percentage
    percentage=80%
    echo $percentage
    sudo mkinitcpio -P
    sleep 1
    touch /tmp/upd-stg1-done
    percentage=90%
    echo $percentage
    touch /tmp/upd-stg2-done
    sleep 1
    touch /tmp/upd-stg3-done
    percentage=100%
    echo $percentage
    touch /tmp/upd-stg4-done
    sleep 1
    echo "Update complete. Restart your device to finish."
fi


# if [[ "${DESKTOP_SESSION}" == "plasma" ]]; then
#        echo "HoloISO Updater Beta 1\nCurrent version: ${VERSION_LIST_PRE}\nChecking for updates..."
#fi
#CMD_HOLO_UPDATE=$(sudo pacman -Syyu --noconfirm --needed --ignore=linux-firmware --ignore=grub --ignore=linux --overwrite="*" --quiet | grep nothing)
#VERSION_LIST=$(cat /etc/os-release | grep VARIANT_ID | cut -d '"' -f 2)
#if [[ "${CMD_HOLO_UPDATE}" == " there is nothing to do" ]]; then
#    echo "Your system is up to date."
#    echo "Current version: ${VERSION_LIST_PRE}"
#    exit 7
#else
#    echo "Update complete to version ${VERSION_LIST}. Please restart your device to apply changes."
#fi

if [ -n "$1" ]; then
    case "$1" in
    check)
        updatecheck
        ;;
    '')
        updatenow
        ;;
    esac
    shift
fi
